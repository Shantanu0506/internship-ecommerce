<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Customer Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background: #f8f9fa; }
        .page-title { margin: 20px 0; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">E-commerce Admin</a>
    </div>
</nav>

<div class="container">

    <div class="d-flex justify-content-between page-title">
        <h2>Customer Dashboard</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#customerModal">
            Add New Customer
        </button>
    </div>

    <div class="card">
        <div class="card-header">
            All Customers
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Customer Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="customerTableBody">
                <!-- JS row -->
                </tbody>
            </table>

            <div id="noCustomers" class="text-center text-muted" style="display:none;">
                No customers found.
            </div>
        </div>
    </div>
</div>

<!-- #### Customer Add/Edit Modal #### -->

<div class="modal fade" id="customerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="customerModalLabel">Add Customer</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="customerForm">
                    <div class="mb-3">
                        <label class="form-label">First Name</label>
                        <input type="text" id="firstName" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Last Name</label>
                        <input type="text" id="lastName" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" id="email" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" id="phone" class="form-control">
                    </div>

                    <div class="form-check mb-3">
                        <input type="checkbox" id="customerStatus" class="form-check-input" checked>
                        <label class="form-check-label">Active</label>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="btnSaveCustomer">Save</button>
            </div>

        </div>
    </div>
</div>

<!-- #### Order History Modal #### -->

<div class="modal fade" id="orderHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Order History</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                    <tr>
                        <th>Order ID</th>
                        <th>Total Amount (â‚¹)</th>
                        <th>Status</th>
                        <th>Shipping Address</th>
                    </tr>
                    </thead>
                    <tbody id="orderHistoryBody">
                    </tbody>
                </table>
                <div id="noOrdersHistory" class="text-center text-muted" style="display:none;">
                    No orders found for this customer.
                </div>
            </div>

        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let editingCustomerId = null;

    document.addEventListener("DOMContentLoaded", () => {
        loadCustomers();

        document.getElementById("btnSaveCustomer").addEventListener("click", saveCustomer);

        document.getElementById("customerModal").addEventListener("hidden.bs.modal", function () {
            editingCustomerId = null;
            document.getElementById("customerModalLabel").innerText = "Add Customer";
            document.getElementById("customerForm").reset();
            document.getElementById("customerStatus").checked = true;
        });
    });

    function loadCustomers() {
        fetch("/api/users")
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById("customerTableBody");
                const noDiv = document.getElementById("noCustomers");
                tbody.innerHTML = "";

                if (data.length === 0) {
                    noDiv.style.display = "block";
                    return;
                } else {
                    noDiv.style.display = "none";
                }

                data.forEach((u, index) => {
                    const tr = document.createElement("tr");

                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${u.firstName} ${u.lastName}</td>
                        <td>${u.email}</td>
                        <td>${u.phone || ''}</td>
                        <td>
                            ${u.status
                                ? '<span class="badge bg-success">Active</span>'
                                : '<span class="badge bg-secondary">Inactive</span>'}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info me-2" onclick="viewOrderHistory(${u.id})">
                                Orders
                            </button>
                            <button class="btn btn-sm btn-warning me-2"
                                onclick="openEditCustomer(${u.id}, '${u.firstName}', '${u.lastName}', '${u.email}', '${u.phone || ''}', ${u.status})">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deactivateCustomer(${u.id})">
                                Deactivate
                            </button>
                        </td>
                    `;

                    tbody.appendChild(tr);
                });
            })
            .catch(err => {
                console.error("Error loading customers:", err);
                alert("Failed to load customers.");
            });
    }

    function saveCustomer() {
        const firstName = document.getElementById("firstName").value.trim();
        const lastName = document.getElementById("lastName").value.trim();
        const email = document.getElementById("email").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const status = document.getElementById("customerStatus").checked;

        if (!firstName || !lastName || !email) {
            alert("First name, last name and email are required.");
            return;
        }

        const payload = {
            firstName: firstName,
            lastName: lastName,
            email: email,
            phone: phone,
            status: status
        };

        let url = "/api/users";
        let method = "POST";

        if (editingCustomerId !== null) {
            url = `/api/users/${editingCustomerId}`;
            method = "PUT";
        }

        fetch(url, {
            method: method,
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error("Failed to save customer");
                }
                return res.json();
            })
            .then(data => {
                const modalEl = document.getElementById("customerModal");
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                loadCustomers();
            })
            .catch(err => {
                console.error("Error saving customer:", err);
                alert("Error while saving customer.");
            });
    }

    function openEditCustomer(id, firstName, lastName, email, phone, status) {
        editingCustomerId = id;

        document.getElementById("customerModalLabel").innerText = "Edit Customer";
        document.getElementById("firstName").value = firstName;
        document.getElementById("lastName").value = lastName;
        document.getElementById("email").value = email;
        document.getElementById("phone").value = phone;
        document.getElementById("customerStatus").checked = status;

        new bootstrap.Modal(document.getElementById("customerModal")).show();
    }

    function deactivateCustomer(id) {
        if (!confirm("Are you sure you want to deactivate this customer?")) {
            return;
        }

        fetch(`/api/users/${id}`, {
            method: "DELETE"
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error("Failed to deactivate customer");
                }
                return res.text();
            })
            .then(msg => {
                loadCustomers();
            })
            .catch(err => {
                console.error("Error deactivating customer:", err);
                alert("Error while deactivating customer.");
            });
    }

    function viewOrderHistory(customerId) {
        fetch(`/api/orders/customer/${customerId}`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById("orderHistoryBody");
                const noDiv = document.getElementById("noOrdersHistory");
                tbody.innerHTML = "";

                if (data.length === 0) {
                    noDiv.style.display = "block";
                } else {
                    noDiv.style.display = "none";
                }

                data.forEach(o => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${o.id}</td>
                        <td>${o.totalAmount}</td>
                        <td>${o.orderStatus}</td>
                        <td>${o.shippingAddress || ''}</td>
                    `;
                    tbody.appendChild(tr);
                });

                new bootstrap.Modal(document.getElementById("orderHistoryModal")).show();
            })
            .catch(err => {
                console.error("Error loading order history:", err);
                alert("Failed to load order history.");
            });
    }
</script>

</body>
</html>
