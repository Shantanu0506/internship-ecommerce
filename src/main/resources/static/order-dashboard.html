<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Order Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background: #f8f9fa; }
        .page-title { margin: 20px 0; }
    </style>
</head>

<body>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">E-commerce Admin</a>
    </div>
</nav>

<div class="container">

    <div class="d-flex justify-content-between page-title">
        <h2>Order Dashboard</h2>

        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#orderModal">
            Place New Order
        </button>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>All Orders</span>

            <!-- Status filter (requirement मधलं filter) -->
            <div class="d-flex align-items-center">
                <span class="me-2">Filter Status:</span>
                <select id="statusFilter" class="form-select form-select-sm" style="width: 180px;">
                    <option value="ALL">All</option>
                    <option value="PENDING">Pending</option>
                    <option value="SHIPPED">Shipped</option>
                    <option value="DELIVERED">Delivered</option>
                    <option value="CANCELLED">Cancelled</option>
                </select>
            </div>
        </div>

        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Total Amount (₹)</th>
                        <th>Status</th>
                        <th>Shipping Address</th>
                        <th>Actions</th>
                    </tr>
                </thead>

                <tbody id="orderTableBody">
                    <!-- JS will load orders -->
                </tbody>
            </table>

            <div id="noOrders" class="text-center text-muted" style="display:none;">
                No Orders Found.
            </div>
        </div>
    </div>

</div>

<!-- ############ PLACE ORDER MODAL ############ -->

<div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Place New Order</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="orderForm">

                    <div class="mb-3">
                        <label class="form-label">Customer</label>
                        <select id="orderCustomer" class="form-control" required>
                            <!-- users load here -->
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Total Amount (₹)</label>
                        <input type="number" id="orderAmount" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Shipping Address</label>
                        <textarea id="orderAddress" class="form-control" rows="3"></textarea>
                    </div>

                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="btnPlaceOrder">Place Order</button>
            </div>

        </div>
    </div>
</div>

<!-- ############ UPDATE STATUS MODAL ############ -->

<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Update Order Status</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select New Status</label>
                    <select id="orderStatusSelect" class="form-control">
                        <option value="PENDING">Pending</option>
                        <option value="SHIPPED">Shipped</option>
                        <option value="DELIVERED">Delivered</option>
                        <option value="CANCELLED">Cancelled</option>
                    </select>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button class="btn btn-primary" id="btnUpdateStatus">Update</button>
            </div>

        </div>
    </div>
</div>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let editingStatusOrderId = null;
    let currentStatusFilter = "ALL";

    document.addEventListener("DOMContentLoaded", () => {
        loadOrders();
        loadCustomers();

        document.getElementById("btnPlaceOrder").addEventListener("click", placeOrder);

        document.getElementById("orderModal").addEventListener("hidden.bs.modal", function () {
            document.getElementById("orderForm").reset();
        });

        document.getElementById("btnUpdateStatus").addEventListener("click", updateOrderStatus);

        document.getElementById("statusFilter").addEventListener("change", function () {
            currentStatusFilter = this.value;
            loadOrders();
        });
    });

    /* ############# LOAD ORDERS ############# */

    function loadOrders() {
        fetch("/api/orders")
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById("orderTableBody");
                const noOrdersDiv = document.getElementById("noOrders");

                tbody.innerHTML = "";

                // filter लागू
                const filtered = data.filter(order => {
                    if (currentStatusFilter === "ALL") return true;
                    return order.orderStatus === currentStatusFilter;
                });

                if (filtered.length === 0) {
                    noOrdersDiv.style.display = "block";
                    return;
                } else {
                    noOrdersDiv.style.display = "none";
                }

                filtered.forEach((order, index) => {
                    const tr = document.createElement("tr");

                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${order.id}</td>
                        <td>${order.customer ? order.customer.fullName : '—'}</td>
                        <td>${order.totalAmount}</td>
                        <td>${order.orderStatus}</td>
                        <td>${order.shippingAddress || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-2"
                                onclick="openStatusModal(${order.id}, '${order.orderStatus}')">
                                Update Status
                            </button>
                            <button class="btn btn-sm btn-danger"
                                onclick="cancelOrder(${order.id})">
                                Cancel
                            </button>
                        </td>
                    `;

                    tbody.appendChild(tr);
                });
            })
            .catch(err => {
                console.error("Error loading orders:", err);
                alert("Failed to load orders.");
            });
    }

    /* ############# LOAD CUSTOMERS FOR DROPDOWN ############# */

    function loadCustomers() {
        fetch("/api/users")
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById("orderCustomer");
                select.innerHTML = "";

                if (data.length === 0) {
                    const opt = document.createElement("option");
                    opt.value = "";
                    opt.textContent = "No customers found";
                    select.appendChild(opt);
                    return;
                }

                data.forEach(user => {
                    const opt = document.createElement("option");
                    opt.value = user.id;
                    opt.textContent = user.fullName + " (" + user.email + ")";
                    select.appendChild(opt);
                });
            })
            .catch(err => {
                console.error("Error loading users:", err);
                alert("Failed to load customers.");
            });
    }

    /* ############# PLACE NEW ORDER ############# */

    function placeOrder() {
        const customerSelect = document.getElementById("orderCustomer");
        const amountInput = document.getElementById("orderAmount");
        const addressInput = document.getElementById("orderAddress");

        const customerId = parseInt(customerSelect.value);
        const totalAmount = parseFloat(amountInput.value);
        const shippingAddress = addressInput.value.trim();

        if (isNaN(customerId)) {
            alert("Please select a customer.");
            return;
        }
        if (isNaN(totalAmount) || totalAmount <= 0) {
            alert("Please enter a valid amount.");
            return;
        }

        const payload = {
            customer: { id: customerId },
            totalAmount: totalAmount,
            shippingAddress: shippingAddress
            // orderStatus default PENDING
        };

        fetch("/api/orders", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error("Failed to place order");
                }
                return res.json();
            })
            .then(data => {
                document.getElementById("orderForm").reset();

                const modalEl = document.getElementById("orderModal");
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                loadOrders();
            })
            .catch(err => {
                console.error("Error placing order:", err);
                alert("Error while placing order.");
            });
    }

    /* ############# UPDATE STATUS ############# */

    function openStatusModal(orderId, currentStatus) {
        editingStatusOrderId = orderId;
        const select = document.getElementById("orderStatusSelect");
        select.value = currentStatus; // current status select

        new bootstrap.Modal(document.getElementById("statusModal")).show();
    }

    function updateOrderStatus() {
        if (editingStatusOrderId == null) return;

        const select = document.getElementById("orderStatusSelect");
        const newStatus = select.value;

        fetch(`/api/orders/${editingStatusOrderId}/status?status=${newStatus}`, {
            method: "PUT"
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error("Failed to update status");
                }
                return res.json();
            })
            .then(data => {
                editingStatusOrderId = null;

                const modalEl = document.getElementById("statusModal");
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                loadOrders();
            })
            .catch(err => {
                console.error("Error updating status:", err);
                alert("Error while updating order status.");
            });
    }

    /* ############# CANCEL ORDER (SOFT DELETE) ############# */

    function cancelOrder(id) {
        if (!confirm("Are you sure you want to cancel this order?")) {
            return;
        }

        fetch(`/api/orders/${id}`, {
            method: "DELETE"
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error("Failed to cancel order");
                }
                return res.text();
            })
            .then(msg => {
                loadOrders();
            })
            .catch(err => {
                console.error("Error cancelling order:", err);
                alert("Error while cancelling order.");
            });
    }
</script>

</body>
</html>
