<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Category Dashboard - Admin</title>

<!-- Bootstrap CSS CDN -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet">

<style>
body {
	background-color: #f8f9fa;
}

.page-title {
	margin-top: 20px;
	margin-bottom: 20px;
}

.status-badge {
	font-size: 0.8rem;
}
</style>
</head>
<body>

	<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
		<div class="container-fluid">
			<a class="navbar-brand" href="#">E-commerce Admin</a>
		</div>
	</nav>

	<div class="container">

		<div
			class="d-flex justify-content-between align-items-center page-title">
			<h2>Category Dashboard</h2>
			<!-- पुढच्या step ला Add Category button कामाला आणू -->
			<button class="btn btn-primary" data-bs-toggle="modal"
				data-bs-target="#categoryModal">Add Category</button>

		</div>

		<div class="card">
			<div class="card-header">All Categories</div>
			<div class="card-body">
				<table class="table table-striped table-hover">
					<thead class="table-dark">
						<tr>
							<th>#</th>
							<th>Category Name</th>
							<th>Description</th>
							<th>Products</th>
							<th>Status</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody id="categoryTableBody">
						<!-- JS ने rows add होतील -->
					</tbody>
				</table>

				<div id="noData" class="text-center text-muted"
					style="display: none;">No categories found. Please add a
					category.</div>
			</div>
		</div>
	</div>

	<!-- Add / Edit Category Modal -->
	<div class="modal fade" id="categoryModal" tabindex="-1"
		aria-labelledby="categoryModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="categoryModalLabel">Add Category</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="categoryForm">
						<div class="mb-3">
							<label for="categoryName" class="form-label">Category
								Name</label> <input type="text" class="form-control" id="categoryName"
								required>
						</div>

						<div class="mb-3">
							<label for="categoryDescription" class="form-label">Description</label>
							<textarea class="form-control" id="categoryDescription" rows="3"></textarea>
						</div>

						<div class="form-check mb-3">
							<input class="form-check-input" type="checkbox"
								id="categoryStatus" checked> <label
								class="form-check-label" for="categoryStatus"> Active </label>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary" id="btnSaveCategory">Save</button>
				</div>
			</div>
		</div>
	</div>


	<!-- Bootstrap JS Bundle -->
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

	<script>
    // page load झाल्यावर dashboard data load करायचं
    let editingCategoryId = null; // आत्तासाठी आपण फक्त Add वापरू, नंतर Edit साठी वापरू
    
    document.addEventListener("DOMContentLoaded", function () {
        loadCategoryDashboard();

        const btnSave = document.getElementById("btnSaveCategory");
        btnSave.addEventListener("click", function () {
            saveCategory();
        });
    });

    function saveCategory() {
        const nameInput = document.getElementById("categoryName");
        const descInput = document.getElementById("categoryDescription");
        const statusInput = document.getElementById("categoryStatus");

        const name = nameInput.value.trim();
        const description = descInput.value.trim();
        const status = statusInput.checked;

        if (name === "") {
            alert("Category name is required.");
            nameInput.focus();
            return;
        }

        const payload = {
            name: name,
            description: description,
            status: status
        };

        let url = "/api/categories";
        let method = "POST";

        if (editingCategoryId !== null) {
            url = `/api/categories/${editingCategoryId}`;
            method = "PUT";
        }

        editingCategoryId = null;
        document.getElementById("categoryModalLabel").innerText = "Add Category";


        fetch(url, {
            method: method,
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to save category");
                }
                return response.json();
            })
            .then(data => {
                // form clear करा
                document.getElementById("categoryForm").reset();
                document.getElementById("categoryStatus").checked = true;

                // modal hide करा
                const modalEl = document.getElementById("categoryModal");
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                // table refresh करा
                loadCategoryDashboard();
            })
            .catch(error => {
                console.error("Error while saving category:", error);
                alert("Error: Unable to save category.");
            });
    }


    function loadCategoryDashboard() {
        fetch("/api/categories/dashboard")
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then(data => {
                const tbody = document.getElementById("categoryTableBody");
                const noDataDiv = document.getElementById("noData");
                tbody.innerHTML = "";

                if (data.length === 0) {
                    noDataDiv.style.display = "block";
                    return;
                } else {
                    noDataDiv.style.display = "none";
                }

                data.forEach((cat, index) => {
                    const tr = document.createElement("tr");

                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${cat.name}</td>
                        <td>${cat.description || ""}</td>
                        <td>${cat.productCount}</td>
                        <td>
                            ${cat.status
                                ? '<span class="badge bg-success status-badge">Active</span>'
                                : '<span class="badge bg-secondary status-badge">Inactive</span>'
                            }
                        </td>
                        <td>
                            <button class="btn btn-sm btn-warning me-2" onclick="openEditModal(${cat.id}, '${cat.name}', '${cat.description || ""}', ${cat.status})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCategory(${cat.id})">Delete</button>
                        </td>
                    `;


                    tbody.appendChild(tr);
                });
            })
            .catch(error => {
                console.error("Error while loading dashboard:", error);
                alert("Failed to load category dashboard data.");
            });    
    }
    
    function openEditModal(id, name, description, status) {
        editingCategoryId = id; // global variable

        document.getElementById("categoryModalLabel").innerText = "Edit Category";
        document.getElementById("categoryName").value = name;
        document.getElementById("categoryDescription").value = description;
        document.getElementById("categoryStatus").checked = status;

        const modal = new bootstrap.Modal(document.getElementById("categoryModal"));
        modal.show();
    }

    function deleteCategory(id) {
        if (!confirm("Are you sure you want to deactivate this category?")) {
            return;
        }

        fetch(`/api/categories/${id}`, {
            method: "DELETE"
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Delete failed");
                }
                return response.text();
            })
            .then(msg => {
                loadCategoryDashboard();
            })
            .catch(err => {
                console.error("Error deleting category:", err);
                alert("Failed to delete category.");
            });
    }

    document.getElementById("categoryModal").addEventListener("hidden.bs.modal", function () {
        editingCategoryId = null;
        document.getElementById("categoryModalLabel").innerText = "Add Category";
        document.getElementById("categoryForm").reset();
        document.getElementById("categoryStatus").checked = true;
    });

</script>

</body>
</html>
