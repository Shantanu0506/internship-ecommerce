<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Product Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background: #f8f9fa; }
        .page-title { margin: 20px 0; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">E-commerce Admin</a>
    </div>
</nav>

<div class="container">

    <div class="d-flex justify-content-between align-items-center page-title">
        <h2>Product Dashboard</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal">
            Add Product
        </button>
    </div>

    <div class="card">
        <div class="card-header">
            All Products
        </div>
        <div class="card-body">

            <table class="table table-striped table-hover">
                <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Product Name</th>
                    <th>Category</th>
                    <th>Price (₹)</th>
                    <th>SKU</th>
                    <th>Inventory</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>

                <tbody id="productTableBody">
                <!-- JS will load rows here -->
                </tbody>
            </table>

            <div id="noProduct" class="text-center text-muted" style="display: none;">
                No products found.
            </div>

        </div>
    </div>
</div>

<!-- ########################## Modal ########################## -->

<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <form id="productForm">

                    <div class="mb-3">
                        <label class="form-label">Product Name</label>
                        <input type="text" id="productName" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea id="productDescription" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Price (₹)</label>
                        <input type="number" id="productPrice" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">SKU</label>
                        <input type="text" id="productSku" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Inventory Count</label>
                        <input type="number" id="productInventory" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select id="productCategory" class="form-control" required>
                            <!-- Categories will be loaded here -->
                        </select>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="productStatus" checked>
                        <label class="form-check-label">Active</label>
                    </div>

                </form>

            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="btnSaveProduct">Save</button>
            </div>

        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let editingProductId = null;

    document.addEventListener("DOMContentLoaded", () => {
        loadProducts();
        loadCategories();

        const btnSave = document.getElementById("btnSaveProduct");
        btnSave.addEventListener("click", () => {
            saveProduct();
        });

        document.getElementById("productModal").addEventListener("hidden.bs.modal", function () {
            editingProductId = null;
            document.getElementById("productModalLabel").innerText = "Add Product";
            document.getElementById("productForm").reset();
            document.getElementById("productStatus").checked = true;
        });
    });

    /* ########################## LOAD PRODUCTS ########################## */

    function loadProducts() {
        fetch("/api/products")
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById("productTableBody");
                const info = document.getElementById("noProduct");

                tbody.innerHTML = "";

                if (data.length === 0) {
                    info.style.display = "block";
                    return;
                } else {
                    info.style.display = "none";
                }

                data.forEach((p, index) => {
                    const tr = document.createElement("tr");

                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${p.name}</td>
                        <td>${p.category ? p.category.name : '—'}</td>
                        <td>${p.price}</td>
                        <td>${p.sku || ''}</td>
                        <td>${p.inventoryCount}</td>
                        <td>
                            ${p.status
                                ? '<span class="badge bg-success">Active</span>'
                                : '<span class="badge bg-secondary">Inactive</span>'}
                        </td>
                        <td>
                            <button class="btn btn-warning btn-sm me-2"
                                onclick="openEditProduct(${p.id}, '${p.name}', '${p.description || ''}',
                                ${p.price}, ${p.inventoryCount}, ${p.category ? p.category.id : 0},
                                '${p.sku || ''}', ${p.status})">
                                Edit
                            </button>
                            <button class="btn btn-danger btn-sm"
                                onclick="deleteProduct(${p.id})">
                                Delete
                            </button>
                        </td>
                    `;

                    tbody.appendChild(tr);
                });

            });
    }

    /* ########################## LOAD CATEGORIES ########################## */

    function loadCategories() {
        fetch("/api/categories")
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById("productCategory");
                select.innerHTML = "";

                data.forEach(cat => {
                    const option = document.createElement("option");
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            });
    }

    /* ##################### OPEN EDIT PRODUCT ##################### */

    function openEditProduct(id, name, desc, price, inventory, categoryId, sku, status) {
        editingProductId = id;

        document.getElementById("productModalLabel").innerText = "Edit Product";
        document.getElementById("productName").value = name;
        document.getElementById("productDescription").value = desc;
        document.getElementById("productPrice").value = price;
        document.getElementById("productSku").value = sku;
        document.getElementById("productInventory").value = inventory;
        document.getElementById("productStatus").checked = status;
        document.getElementById("productCategory").value = categoryId;

        new bootstrap.Modal(document.getElementById("productModal")).show();
    }

    /* ######################## SAVE PRODUCT (ADD / EDIT) ######################## */

    function saveProduct() {
        const nameInput = document.getElementById("productName");
        const descInput = document.getElementById("productDescription");
        const priceInput = document.getElementById("productPrice");
        const skuInput = document.getElementById("productSku");
        const inventoryInput = document.getElementById("productInventory");
        const categorySelect = document.getElementById("productCategory");
        const statusInput = document.getElementById("productStatus");

        const name = nameInput.value.trim();
        const description = descInput.value.trim();
        const price = parseFloat(priceInput.value);
        const sku = skuInput.value.trim();
        const inventory = parseInt(inventoryInput.value);
        const categoryId = parseInt(categorySelect.value);
        const status = statusInput.checked;

        if (name === "" || sku === "" || isNaN(price) || isNaN(inventory) || isNaN(categoryId)) {
            alert("Please fill all required fields.");
            return;
        }

        const payload = {
            name: name,
            description: description,
            price: price,
            sku: sku,
            inventoryCount: inventory,
            status: status,
            category: {
                id: categoryId
            }
        };

        let url = "/api/products";
        let method = "POST";

        if (editingProductId !== null) {
            url = `/api/products/${editingProductId}`;
            method = "PUT";
        }

        fetch(url, {
            method: method,
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error("Failed to save product");
                }
                return res.json();
            })
            .then(data => {
                document.getElementById("productForm").reset();
                document.getElementById("productStatus").checked = true;

                editingProductId = null;
                document.getElementById("productModalLabel").innerText = "Add Product";

                const modalEl = document.getElementById("productModal");
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                loadProducts();
            })
            .catch(err => {
                console.error("Error saving product:", err);
                alert("Error while saving product.");
            });
    }

    /* ######################## DELETE PRODUCT (SOFT DELETE) ######################## */

    function deleteProduct(id) {
        if (!confirm("Are you sure you want to deactivate this product?")) {
            return;
        }

        fetch(`/api/products/${id}`, {
            method: "DELETE"
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error("Failed to delete product");
                }
                return res.text();
            })
            .then(msg => {
                loadProducts();
            })
            .catch(err => {
                console.error("Error deleting product:", err);
                alert("Error while deleting product.");
            });
    }
</script>

</body>
</html>
